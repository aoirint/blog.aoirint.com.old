
<!DOCTYPE html>
<html lang="ja-JP">
<head>
  

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ArduinoのPWM信号をアナログスイッチで非同時マルチチャンネル音源として使う - えやみぐさ</title>
  


<link rel="shortcut icon" href="../../../favicon.ico">




<meta property="og:url" content="https://blog.aoirint.com/entry/2020/multi_channel_speaker/" />
<meta property="og:locale" content="ja-JP" />
<meta property="og:type" content="article" />

<meta property="og:title" content="ArduinoのPWM信号をアナログスイッチで非同時マルチチャンネル音源として使う - えやみぐさ" />

<meta name="description" content="ArduinoのPWM信号をアナログスイッチで非同時マルチチャンネル音源として使う"/>
<meta property="og:description" content="ArduinoのPWM信号をアナログスイッチで非同時マルチチャンネル音源として使う" />
<meta property="og:image" content="https://blog.aoirint.com/ogp.png" />
<meta property="article:published_time" content="2020-09-20T08:00:00+09:00" />

<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@aoirint">
<meta name="twitter:creator" content="@aoirint">


<link href="https://blog.aoirint.com/atom.xml" type="application/atom+xml" rel="alternate" title="えやみぐさ Atom Feed" />
<link href="https://blog.aoirint.com/rss.rdf" type="application/rss+xml" rel="alternate" title="えやみぐさ RSS Feed" />

<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../../../static/aoirint-blog/css/style.css">

<script defer src="../../../static/fontawesome/js/all.min.js"></script>
  <script defer src="../../../static/fontawesome/js/v4-shims.min.js"></script>
<link rel="stylesheet" href="../../../static/pygments/native.css">


    
  

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-157155944-5"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-157155944-5');
  </script>
  

<script src="../../../static/aoirint-blog/js/main.js"></script>

<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>


</head>

<body>
  

<nav class="sitebar">
  <div class="sitebar-left">
    
    <a href="https://cse.google.com/cse?cx=4b57e8a4ef2a8c489" target="_blank" class="sitebar-button">
      <i class="fas fa-search"></i>
    </a>
    

    <a href="../../../atom.xml" title="RSS Feed" class="sitebar-button">
      <i class="fas fa-rss"></i>
    </a>

  <!--
    <a href="../../../atom.xml" title="Atom Feed" class="sitebar-button">
      <i class="fas fa-rss"></i>
    </a>
  -->

    
    <a href="https://twitter.com/aoirint" target="_blank" title="Twitter @aoirint" class="sitebar-button">
      <i class="fab fa-twitter"></i>
    </a>
    

    
    <a href="https://github.com/aoirint" target="_blank" title="GitHub @aoirint" class="sitebar-button">
      <i class="fab fa-github"></i>
    </a>
    
  </div>


  <div class="sitebar-center">
    <a href="../../../" class="sitebar-title">
      えやみぐさ
    </a>
    
    <div class="sitebar-description">
      Blog by aoirint
    </div>
    
  </div>

  <div class="sitebar-right">
    <button class="toggle-tocbar sitebar-button" type="button" onclick="toggleTocBarIfSmartphone();">
      <i class="fas fa-list"></i>
    </button>

  </div>

</nav>

<main class="main-content">

<div class="container">


<article class="article">


<div class="article-metadata">
  <div class="article-date">
    2020-09-20
  </div>

  <div class="article-tags">

    <a href="../../../category/Arduino/" class="article-category">
      Arduino
    </a>



    <a href="../../../tags/電子回路/" class="article-tag">
      電子回路
    </a>

    <a href="../../../tags/Arduino/" class="article-tag">
      Arduino
    </a>

    <a href="../../../tags/PWM制御/" class="article-tag">
      PWM制御
    </a>

  </div>

</div>



<div class="article-body">
  <h1 class="md_header_block" id="h_entry_2020_multi_channel_speaker_index_md_ArduinoのPWM信号をアナログスイッチで非同時マルチチャンネル音源として使う">ArduinoのPWM信号をアナログスイッチで非同時マルチチャンネル音源として使う</h1>
<p><a href="https://www.marutsu.co.jp/pc/i/37603/">4回路入り CMOSアナログスイッチ TC74HC4066AP(F)｜電子部品・半導体通販のマルツ</a></p>
<p>アナログスイッチというものを買って試してみました。
その名の通りアナログ信号をスイッチングするICです。
このICには4回路入っています（4つスイッチがあります）。
アナログ信号（PWM信号）源としてArduino UNO（互換品）を使いました。</p>
<h2 class="md_header_block" id="h_entry_2020_multi_channel_speaker_index_md_PWM">PWM</h2>
<p>PWM（Pulse Width Modulation）はパルス信号の幅（デューティ比）を変化させる変調のことです。
ここでは、スイッチのON/OFFの比率を調節する形で、
デジタルパルス信号の平均電圧を可変にする（擬似的なアナログ信号を作る）ために使います（参考：<a href="https://ja.wikipedia.org/wiki/%E3%83%91%E3%83%AB%E3%82%B9%E5%B9%85%E5%A4%89%E8%AA%BF">パルス幅変調 - Wikipedia</a>）。</p>
<p>[
  デューティ比 = \frac{{\rm ON} の時間（=パルス幅）}{パルスの周期}
]</p>
<p>パルス幅 1μs、パルス周期 4μs（つまりON 1μs、OFF 3μsの繰り返し）のとき、デューティ比は0.25になります（参考：<a href="https://ja.wikipedia.org/wiki/%E3%83%87%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E6%AF%94">デューティ比 - Wikipedia</a>）。</p>
<p>デューティ比 (D) 、パルス電圧 (V) のとき、平均電圧 (V' = D V) となります。</p>
<h2 class="md_header_block" id="h_entry_2020_multi_channel_speaker_index_md_ArduinoのPWM制御">ArduinoのPWM制御</h2>
<p>ArduinoにはPWMを利用したアナログ出力関数（<a href="https://cdn.arduino.cc/reference/jp/language/functions/analog-io/analogwrite/">analogWrite - Arduinoリファレンス</a>）があります。</p>
<ul>
<li><a href="https://www.arduino.cc/en/Tutorial/PWM">Arduino - PWM</a></li>
</ul>
<p><a href="https://labview.exblog.jp/20465460/">Arduino PWM 周波数　高速化 : LabVIEW　info. Sharing 新館</a>、
<a href="https://ehbtj.com/electronics/speedup-arduino/">Arduinoの高速化 | なんでも独り言</a>、
<a href="https://qiita.com/autumn-position/items/ac016c58190f77f66a13">Arduinoプログラムの高速化 - Qiita</a>
を参考にしていきます。</p>
<p>まず今回の内容とはあまり関係ないですが、
Arduinoの標準的な関数を使ったGPIO制御は（安全で楽、また互換性が高いですが）遅いということで、
Arduinoの本体であるAVRマイコンATmegaのレジスタを直接操作することで、高速化が見込めるらしいです。
注意点や詳しいことはリンク先の参照をお願いします。</p>
<p>また、ArduinoのデフォルトのPWM制御は、
動作クロックに対する分周比がだいたいのピンで64になっていて、
動作クロック16MHzのUNOの場合、約490Hzのパルスを使ったPWMになっているということです（オシロがほしいです..）。
これもタイマー関連のレジスタを直接操作して分周比を変更することで、PWMの周波数を変えることができます。</p>
<p>今回はPCで再生するような音声信号をPWMで再生します。よくある音声のサンプリング周波数は44100Hzまたは48000Hz（この周期で振幅＝電圧が変化する）で、これを再生するには490Hzのパルスでは遅すぎます。</p>
<h2 class="md_header_block" id="h_entry_2020_multi_channel_speaker_index_md_音声データの設定">音声データの設定</h2>
<p><a href="https://nn-hokuson.hatenablog.com/entry/2017/09/01/092945">【Arduino】WAVまたはMP3ファイルを再生する - おもちゃラボ</a>を参考にしていきます。</p>
<p>今回は音声データをArduinoのプログラムメモリに直接載せて再生することにします。
手元のArduino UNO互換機ではプログラムメモリ容量32256 bytesだったので、
音声データを載せるにも再生プログラムと合わせてこの範囲に収める必要があります。</p>
<p>そこで割とよく見るやり方で、データ量を減らすためにサンプリング周波数を8000Hzに落として、生の8bit波形を直接ソースコードに埋め込んでいきます。PWMの周波数が十分大きく、巨大な波形データを何らかの方法で格納できればサンプリング周波数を上げることができそうですが、今回はこの形でいきます。</p>
<p>シリアル通信で波形データをリアルタイムに送るのは遅すぎて無理と思われるので、
そのような場合にはMicroSDカード（TFカード）から読み出しながら再生するのがよさそうです。
シリアル通信経由で音源データをあらかじめ書き込むためのAPIくらいは作れるかもしれないですね。</p>
<p>音源には著作権の切れているハレルヤ・コーラスの頭近くから2秒分を切り出したものを使ってみます。生の波形（handel_2s.raw）はモノラル 8000Hz 2秒 振幅8bitで16000 bytesになります。</p>
<ul>
<li><a href="https://commons.wikimedia.org/wiki/File:Messiah_Hallelujah_Chorus_1916.ogg">File:Messiah Hallelujah Chorus 1916.ogg - Wikimedia Commons</a></li>
<li><a href="handel_2s.wav">handel_2s.wav</a>（44100Hz）</li>
<li><a href="handel_2s.raw">handel_2s.raw</a>（8000Hz、8bit）</li>
</ul>
<p>音声データは3番ピン（Timer/Counter2、OCR2B）から出力することにします。</p>
<p><code>xxd</code>コマンドが使える場合、<code>xxd -i handel_2s.raw</code>で<code>unsigned char handel_2s_raw[]</code>を定義するCコードが出力されます。この頭に<code>const PROGMEM</code>を付けてArduino用のソースコードに貼り付けます。</p>
<h2 class="md_header_block" id="h_entry_2020_multi_channel_speaker_index_md_単チャンネル再生">単チャンネル再生</h2>
<p>基本的には先に挙げた記事と同じことをしていきます。シリアル通信を入れると遅くなってしまうので、動作確認などで入れた場合は最終的には外したほうがいいです。</p>
<ul>
<li><a href="https://garretlab.web.fc2.com/arduino/inside/hardware/arduino/avr/cores/arduino/wiring_analog.c/analogWrite.html" title="analogWrite()">analogWrite() - Arduinoで遊ぶページ</a></li>
<li><a href="https://avrwiki.osdn.jp/cgi-bin/wiki.cgi?page=Timer2" title="Timer2 - FreeStyleWiki">Timer2 - AVRWiki</a></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">const</span> <span class="n">PROGMEM</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">handel_2s_raw</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// 略</span>
<span class="p">};</span>
<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">handel_2s_raw_len</span> <span class="o">=</span> <span class="mi">16000</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">TCCR2A</span> <span class="o">=</span> <span class="n">_BV</span><span class="p">(</span><span class="n">COM2B1</span><span class="p">)</span> <span class="o">|</span> <span class="n">_BV</span><span class="p">(</span><span class="n">WGM21</span><span class="p">)</span> <span class="o">|</span> <span class="n">_BV</span><span class="p">(</span><span class="n">WGM20</span><span class="p">);</span>
  <span class="n">TCCR2B</span> <span class="o">=</span> <span class="n">_BV</span><span class="p">(</span><span class="n">CS20</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">OCR2B</span> <span class="o">=</span> <span class="n">pgm_read_byte_near</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handel_2s_raw</span><span class="p">[</span><span class="n">counter</span><span class="p">]);</span>

  <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">&gt;</span> <span class="n">handel_2s_raw_len</span><span class="p">)</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">125</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Arduinoの3番ピン・GNDのとスピーカの端子（ダイナミックスピーカの場合はPAM8012やPAM8403などのアンプがほしい、圧電スピーカ・イヤホンなどの場合は不要）を接続する。</p>
<h2 class="md_header_block" id="h_entry_2020_multi_channel_speaker_index_md_多チャンネル再生">多チャンネル再生</h2>
<h3 class="md_header_block" id="h_entry_2020_multi_channel_speaker_index_md_回路の設定">回路の設定</h3>
<p>図を<a href="https://www.marutsu.co.jp/pc/i/37603/">TC74HC4066A</a>の<a href="https://www.marutsu.co.jp/contents/shop/marutsu/datasheet/TC74HC4066A.pdf">データシート</a>から引用していきます。</p>
<p><img alt="TC74HC4066A_1" height="320px" src="TC74HC4066A_1.png" width="320px"/></p>
<p>とりあえずArduinoの4、5、6、7番ピンをアナログスイッチのスイッチングに使います
（ラインデコーダなんかを使って2bitにしてもよさそうですが）。
これはデータシートから、それぞれIC側の13、5、6、12番ピン（1C、2C、3C、4C）に接続します。</p>
<p><img alt="TC74HC4066A_2" height="160px" src="TC74HC4066A_2.png" width="288px"/></p>
<p>各ピンがHighのときにn I/Oがn O/Iに出力されます。例えば、1C=Highのとき、1 O/I = 1 I/O（アナログ信号）になり、1C=Lowのとき、1 O/I=0 Vになります。</p>
</div>

</article>


</div>

</main>

<aside class="tocbar-box">
  <nav class="tocbar fixed-scrollable">

<div class="toc-box">
  <h4><a href="./" style="color: inherit; text-decoration: none;">Table of Contents</a></h4>
  <ul class="toc">
  
    <li>
      <a href="#h_entry_2020_multi_channel_speaker_index_md_ArduinoのPWM信号をアナログスイッチで非同時マルチチャンネル音源として使う" class="toc-item toc-item-h1">
        ArduinoのPWM信号をアナログスイッチで非同時マルチチャンネル音源として使う
      </a>
  
    <li>
      <a href="#h_entry_2020_multi_channel_speaker_index_md_PWM" class="toc-item toc-item-h2">
        PWM
      </a>
  
    <li>
      <a href="#h_entry_2020_multi_channel_speaker_index_md_ArduinoのPWM制御" class="toc-item toc-item-h2">
        ArduinoのPWM制御
      </a>
  
    <li>
      <a href="#h_entry_2020_multi_channel_speaker_index_md_音声データの設定" class="toc-item toc-item-h2">
        音声データの設定
      </a>
  
    <li>
      <a href="#h_entry_2020_multi_channel_speaker_index_md_単チャンネル再生" class="toc-item toc-item-h2">
        単チャンネル再生
      </a>
  
    <li>
      <a href="#h_entry_2020_multi_channel_speaker_index_md_多チャンネル再生" class="toc-item toc-item-h2">
        多チャンネル再生
      </a>
  
    <li>
      <a href="#h_entry_2020_multi_channel_speaker_index_md_回路の設定" class="toc-item toc-item-h3">
        回路の設定
      </a>
  
  </ul>

</div>


  </nav>
</aside>

<footer class="footer">

  <p class="copyright-text">
    Copyright © 2020- aoirint.

  <p class="theme-text">
    Theme
    <a href="https://github.com/aoirint/aoirint-miyadaiku-theme-blog">aoirint-miyadaiku-theme-blog</a>.
  <p class="poweredby-text">
    Powered by
    <a href="https://github.com/miyadaiku/miyadaiku">Miyadaiku</a>.
</footer>


</body>
</html>